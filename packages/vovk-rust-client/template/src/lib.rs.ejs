---
imports: ['vovk-rust-client']
---
<% const vars = {
    convertJSONSchemasToRustTypes: t.imports['vovk-rust-client'].convertJSONSchemasToRustTypes,
}; %>
<%- `// auto-generated ${new Date().toISOString()}` %>
mod http_request;
mod read_full_schema;

<% Object.entries(t.fullSchema.segments).forEach(([segmentName, segment]) => {
    Object.values(segment.controllers).forEach(({ prefix, handlers, rpcModuleName }) => { %>
pub mod <%= t._.snakeCase(rpcModuleName) %> {
    #[allow(unused_imports)]
    use crate::http_request::{http_request, http_request_stream};
    use std::collections::HashMap;
<% Object.entries(handlers).forEach(([handlerNameOriginal, { validation, openapi, path, httpMethod }]) => { 
    const handlerName = t._.snakeCase(handlerNameOriginal);
    %>
    // <%= rpcModuleName %>.<%= handlerName %> <%= httpMethod %> <%= t.apiRoot %>/<%= segmentName %>/<%= prefix %>/<%= path %>
<%- 
vars.convertJSONSchemasToRustTypes({ 
    schemas: {
        body: validation?.body,
        query: validation?.query,
        params: validation?.params,
        output: validation?.output,
        iteration: validation?.iteration
    }, 
    rootName: handlerName, 
    pad: 4 
})
%>
    /** 
<%= ([
                openapi?.summary ?? 'No summary',
                openapi?.description ? `Description: ${openapi.description}` : '',
                validation?.body?.description ? `Body: ${validation?.body?.description}`: '',
                validation?.query?.description ? `Query: ${validation?.query?.description}`: '',
                validation?.output?.description ? `Returns: ${validation?.output?.description}`: ''
            ]).filter(Boolean).map((s) => ' '.repeat(8) + s).join('\n') %>
    */
    pub fn <%= handlerName %>( 
        body: <%- validation?.body ? `${handlerName}_::body` : '()' %>,
        query: <%- validation?.query ? `${handlerName}_::query` : '()' %>,
        params: <%- validation?.params ? `${handlerName}_::params` : '()' %>,
        headers: Option<&HashMap<String, String>>,
        api_root: Option<&str>,
        disable_client_validation: bool,
    ) -> <%- validation?.output ? `Result<${handlerName}_::output, Box<dyn serde::ser::StdError>>` : validation?.iteration ? `Box<dyn Iterator<Item = ${handlerName}_::iteration>>` : 'Result<serde_json::Value, Box<dyn serde::ser::StdError>>' %>{
        let result = <%= validation?.iteration ? 'http_request_stream' : 'http_request' %>::<
<%- [
                validation?.output ? `${handlerName}_::output` : validation?.iteration ? `${handlerName}_::iteration` : 'serde_json::Value',
                validation?.body ? `${handlerName}_::body` : '()',
                validation?.query ? `${handlerName}_::query` : '()',
                validation?.params ? `${handlerName}_::params` : '()'
            ].filter(Boolean).map((s) => ' '.repeat(12) + s).join(',\n') %>
        >(
            "<%= t.apiRoot %>",
            "<%= segmentName %>",
            "<%= rpcModuleName %>",
            "<%= handlerNameOriginal %>",
            Some(&body),
            Some(&query),
            Some(&params),
            headers,
            api_root,
            disable_client_validation,
        );

        result
    }
        <% }) %>
}
    <% }) %>

<% }) %>

